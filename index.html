<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Concrete-Filled Steel Tube Column Capacity Calculator</title>
    <!-- Import Excel processing library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            text-align: center;
            font-size: 18px;
            line-height: 1.5;
            color: #333;
        }
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            padding: 20px; 
            background: #f8f9fa; 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .input-group { 
            margin: 15px 0; 
            padding: 15px 20px; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .input-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .input-row { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); 
            gap: 15px; 
        }
        .param-label { 
            margin-bottom: 5px; 
            font-weight: 500;
        }
        .param-label i { font-style: italic; }
        input { 
            width: 100%; 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        .file-upload { 
            border: 2px dashed #ccc; 
            padding: 15px; 
            text-align: center; 
            margin: 15px 0;
            border-radius: 6px;
            transition: border-color 0.2s;
        }
        .file-upload:hover {
            border-color: #3498db;
        }
        #resultTable { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px;
            font-size: 14px;
        }
        #resultTable th, #resultTable td { 
            border: 1px solid #e9ecef; 
            padding: 10px; 
            text-align: center; 
        }
        #resultTable th { 
            background-color: #f1f3f5;
            font-weight: 600;
        }
        .highlight { color: #e74c3c; font-weight: bold; }
        button { 
            padding: 10px 18px; 
            margin: 5px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 15px;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover { 
            background: #2980b9;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        #exportBtn { display: none; background: #27ae60; }
        .file-input-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        input[type="file"] {
            max-width: 300px;
            font-size: 14px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .result-message {
            margin: 15px 0;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .diagram-container {
            margin: 15px 0;
            padding: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .diagram-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        h3 {
            font-size: 24px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #34495e;
        }
        .parameter-label {
            font-size: 20px;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Fix input overflow issues */
        .single-input-wrapper {
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <h1>Axial load-capacity of CFST columns with local defect</h1>
    <div class="container">
        <div class="diagram-container">
            <img src="Diagram.jpg" alt="CFST Column Diagram showing cross-section with local defect">
        </div>
        
        <!-- Single Calculation Section -->
        <div class="input-group">
            <h3>Single Calculation</h3>
            <p class="parameter-label">Parameters input [<i>f</i><sub>y</sub> (MPa), <i>f</i><sub>c</sub>(MPa), <i>D</i><sub>0</sub>(mm), <i>t</i><sub>0</sub>(mm), <i>L</i>(mm), <i>d</i>(mm), <i>α</i>(°), <i>l</i>(mm), <i>h</i>(mm)]</p>
            <div class="single-input-wrapper">
                <input type="text" id="singleInput" placeholder="Enter parameters separated by comma or space">
            </div>
            <button onclick="singleCalculate()">Calculate</button>
            <div id="singleResult" class="highlight" style="margin-top:15px;"></div>
        </div>

        <!-- Batch Calculation Section -->
        <div class="input-group">
            <h3>Batch Calculation</h3>
            <p class="parameter-label">Parameters input [<i>f</i><sub>y</sub> (MPa), <i>f</i><sub>c</sub>(MPa), <i>D</i><sub>0</sub>(mm), <i>t</i><sub>0</sub>(mm), <i>L</i>(mm), <i>d</i>(mm), <i>α</i>(°), <i>l</i>(mm), <i>h</i>(mm)]</p>
            <div class="file-upload">
                <div class="file-input-container">
                    <input type="file" id="batchFile" accept=".csv,.xlsx,.txt">
                    <span>Supported formats: CSV, Excel, TXT</span>
                </div>
            </div>
            <button onclick="handleBatchCalculate()">Calculate</button>
            <button id="exportBtn" onclick="exportExcel()">Download Results</button>
            <div id="batchResultMessage" class="result-message" style="display: none;"></div>
            <table id="resultTable" style="display:none;">
                <thead>
                    <tr>
                        <th><i>f</i><sub>y</sub> /MPa</th><th><i>f</i><sub>c</sub> /MPa</th><th><i>D</i><sub>0</sub> /mm</th><th><i>t</i><sub>0</sub> /mm</th>
                        <th><i>L</i> /mm</th><th><i>d</i> /mm</th><th><i>α</i> /°</th><th><i>l</i> /mm</th>
                        <th><i>h</i> /mm</th><th><i>N</i><sub>ud</sub> /kN</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

<script>
/**
 * Core calculation function: Computes CFST column capacity based on input parameters
 * @param {Array} params - Array containing 9 parameters:
 *   [fy, fc, D0, t0, L, d, alpha_deg, l, h]
 * @returns {Object} Result object with either calculated value or error message
 */
function calculate(params) {
    // Convert all parameters to numbers
    const [fy, fc, D0, t0, L, d, alpha_deg, l, h] = params.map(Number);
    
    // Parameter validation
    if (h/L < 0 || h/L > 0.5) return {error: "h/L ratio out of valid range [0, 0.5]"};
    if (d > t0) return {error: "Defect depth exceeds wall thickness"};
    if (isNaN(fy) || isNaN(fc) || isNaN(D0) || isNaN(t0) || isNaN(L) || 
        isNaN(d) || isNaN(alpha_deg) || isNaN(l) || isNaN(h)) {
        return {error: "Invalid parameter format - please use numbers only"};
    }

    // Geometric parameter calculations
    const Rc = D0/2 - t0; // Concrete core radius
    const R = Rc + t0;    // Outer radius
    const td = t0 - d;    // Reduced thickness at defect
    const beta = d / t0;  // Thickness reduction ratio
    
    // Defect parameter calculations
    const alpha_rad = alpha_deg * Math.PI / 180; // Convert angle to radians
    const h_l = Math.min(l/4, 2*Rc);
    const lb = 0.84 * Math.PI * Math.sqrt(R * t0);

    // Critical angle calculation
    const theta = Math.min(alpha_rad/2 + lb/Rc, Math.PI);
    const h_theta = Rc * (1 - Math.cos(theta)/2);

    // Material property definitions
    const E_s = 2e5; // Steel modulus of elasticity (MPa)
    const E_c = 22000 * Math.pow((fc + 8)/10, 0.3); // Concrete modulus (MPa)

    // Cross-sectional property calculations
    const Ac = Math.PI * Rc**2; // Concrete cross-sectional area
    
    // Steel area calculation function
    const As = t => Math.PI * ((Rc + t)**2 - Rc**2);
    
    // Moment of inertia calculation function
    const Is = t => (Math.PI/4) * ((Rc + t)**4 - Rc**4);

    // Capacity calculation function
    const calcNu = t => {
        const N0 = fy*As(t) + fc*Ac; // Nominal axial strength
        const Ncr = (Math.PI**2 * (E_s*Is(t) + 0.6*E_c*(Math.PI/4)*Rc**4)) / L**2; // Critical buckling load
        const lambda = Math.sqrt(N0/Ncr); // Slenderness ratio
        const Rds = Math.min(1.2*Math.exp(-0.7*lambda), 1); // Buckling reduction factor
        const xi = (fy*As(t))/(fc*Ac); // Steel ratio parameter
        return Rds * (1.14 + 1.02*xi) * fc * (As(t)+Ac); // Final capacity calculation
    };

    // Calculate capacities for intact and defective states
    const nu_t0 = calcNu(t0); // Intact section capacity
    const nu_td = calcNu(td); // Defective section capacity

    // Defective area calculation
    let Acd;
    if (h_l <= h_theta) {
        const lb0 = (Math.PI - alpha_rad/2) * Rc;
        const lbx = Math.min(lb, lb0);
        const x_R_raw = (lb/h_l) * (h_l - Rc);
        const x_R = Math.max(x_R_raw, 0);
        
        const term1 = h_l * lbx * (1 - h_l/(3*Rc));
        const term2 = alpha_rad * h_l * (Rc - h_l/2);
        const term3 = (h_l**2 / lb**2) * (Math.PI - (5*x_R)/(6*Rc)) * x_R**2;
        Acd = term1 + term2 + term3;
    } else {
        const theta_term = theta - (Math.sin(theta)*Math.cos(theta))/3;
        Acd = theta_term * Rc**2;
    }

    // Capacity reduction factor calculation
    const phi_p = 1 + 1.5 * (beta * l / L) * (0.5 - h/L);
    const Nud = phi_p * ((Acd/Ac)*nu_td + (1 - Acd/Ac)*nu_t0);
    
    return {
        value: Nud/1000, // Convert to kN
        error: null
    };
}

/**
 * Handles single calculation from input field
 */
function singleCalculate() {
    const input = document.getElementById('singleInput').value.trim();
    
    // Check for empty input
    if (!input) {
        document.getElementById('singleResult').innerHTML = 
            '<p style="color:red">Error: Please enter parameters</p>';
        return;
    }
    
    // Split input parameters using any combination of commas or whitespace
    const params = input.split(/[,\s]+/);
    
    // Validate parameter count
    if (params.length !== 9) {
        document.getElementById('singleResult').innerHTML = 
            `<p style="color:red">Error: Please enter exactly 9 parameters (received ${params.length})</p>`;
        return;
    }

    // Perform calculation and display result
    const result = calculate(params);
    document.getElementById('singleResult').innerHTML = result.error ? 
        `<p style="color:red">${result.error}</p>` :
        `<p><i>N</i><sub>ud</sub> = <span>${result.value.toFixed(2)}</span> kN</p>`;
}

// Store batch calculation results
let batchResults = [];

/**
 * Handles batch calculation from uploaded file
 */
async function handleBatchCalculate() {
    const file = document.getElementById('batchFile').files[0];
    
    // Check if file was selected
    if (!file) return alert("Please upload a file first");
    
    // Read and process file data
    const rawData = await readFile(file);
    
    // Process each row and calculate results
    batchResults = rawData.map(row => {
        // Extract first 9 parameters and convert to numbers
        const params = row.slice(0, 9).map(cell => cell.trim()).map(Number);
        const result = calculate(params);
        return [...params, result.error ? "Error" : result.value];
    });

    // Get UI elements for results display
    const resultMessage = document.getElementById('batchResultMessage');
    const resultTable = document.getElementById('resultTable');
    
    // Display appropriate results based on data volume
    if (batchResults.length <= 200) {
        // Show table for smaller datasets
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = batchResults.map(row => `
            <tr>
                <td>${row[0]?.toFixed(2) || ''}</td>
                <td>${row[1]?.toFixed(2) || ''}</td>
                <td>${row[2]?.toFixed(2) || ''}</td>
                <td>${row[3]?.toFixed(2) || ''}</td>
                <td>${row[4]?.toFixed(2) || ''}</td>
                <td>${row[5]?.toFixed(2) || ''}</td>
                <td>${row[6]?.toFixed(2) || ''}</td>
                <td>${row[7]?.toFixed(2) || ''}</td>
                <td>${row[8]?.toFixed(2) || ''}</td>
                <td>${row[9] === "Error" ? "Error" : row[9]?.toFixed(2) || ''}</td>
            </tr>
        `).join('');
        
        resultTable.style.display = 'table';
        resultMessage.style.display = 'none';
    } else {
        // Show message only for large datasets
        resultTable.style.display = 'none';
        resultMessage.style.display = 'block';
        resultMessage.innerHTML = `Calculation complete. Processed ${batchResults.length} specimens. 
            Results table hidden due to size (over 200 entries). Please download the results file.`;
    }
    
    // Show export button after calculation
    document.getElementById('exportBtn').style.display = 'inline-block';
}

/**
 * Reads and processes uploaded files, filtering out empty rows and headers
 * @param {File} file - Uploaded file object
 * @returns {Promise<Array>} Processed data array
 */
async function readFile(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            let data = [];
            
            // Read Excel files
            if (file.name.endsWith('.xlsx')) {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                // Convert all cells to strings for Excel data
                data = data.map(row => row.map(cell => String(cell).trim()));
            } 
            // Read text-based files (CSV, TXT)
            else {
                data = e.target.result.split('\n')
                   .map(line => line.split(/[,\t]/)) 
                   .map(row => row.map(cell => 
                       typeof cell === 'string' ? cell.trim() : String(cell).trim() // Ensure conversion to string
                   )); 
            }

            // Filter out empty rows and header rows
            const filteredData = data.filter(row => {
                // Skip completely empty rows
                if (row.every(cell => cell === '')) return false;
                
                // Get first 9 cells to check for valid data
                const first9Cells = row.slice(0, 9);
                
                // Skip rows that contain non-numeric values in first 9 positions
                return first9Cells.some(cell => !isNaN(cell) && cell !== '');
            });

            resolve(filteredData);
        };

        // Read file in appropriate format
        if (file.name.endsWith('.xlsx')) {
            reader.readAsArrayBuffer(file);
        } else {
            reader.readAsText(file);
        }
    });
}

/**
 * Exports batch results to Excel file
 */
function exportExcel() {
    // Convert results to JSON format for Excel export
    const ws = XLSX.utils.json_to_sheet(batchResults.map(row => ({
        "fy /MPa": row[0], 
        "fc /MPa": row[1], 
        "D0 /mm": row[2],
        "t0 /mm": row[3], 
        "L /mm": row[4], 
        "d /mm": row[5],
        "α /°": row[6], 
        "l /mm": row[7], 
        "h /mm": row[8],
        "Nud /kN": row[9]
    })));
    
    // Create workbook and export
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "CFST_Results");
    XLSX.writeFile(wb, "CFST_Batch_Results.xlsx");
}
</script>
</body>
</html>
